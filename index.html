<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esports Production Suite V15 - Compact Studio</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Rajdhani:wght@500;600;700&family=Teko:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- 1. CORE VARIABLES & RESET --- */
        :root {
            --accent-yellow: #d4ff00; 
            --accent-red: #ff2a2a;
            --bg-dark: #080808;
            --bg-panel: #111;
            --border-color: #333;
            --text-main: #fff;
            --text-dim: #888;
            --yt-blue: #3ea6ff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; user-select: none; }
        
        body { 
            font-family: 'Rajdhani', sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden; 
        }

        .hidden { display: none !important; }

        /* --- 2. LOGIN SCREEN --- */
        #login-screen {
            position: fixed; inset: 0; z-index: 99999;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box { text-align: center; animation: fadeIn 1s ease; }
        .login-btn {
            background: transparent; border: 2px solid var(--accent-yellow); color: var(--accent-yellow);
            padding: 15px 40px; font-family: 'Teko'; font-size: 24px; letter-spacing: 1px;
            cursor: pointer; margin: 10px; transition: 0.2s; text-transform: uppercase;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .login-btn:hover { background: var(--accent-yellow); color: black; box-shadow: 0 0 20px rgba(212, 255, 0, 0.3); }

        /* --- 3. ADMIN LAYOUT --- */
        #admin-view { display: none; height: 100vh; }

        /* Sidebar */
        .sidebar {
            width: 90px; background: #0f0f0f; border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 15px;
        }
        .nav-item {
            width: 70px; height: 70px; background: #1a1a1a; border: 1px solid var(--border-color); border-radius: 4px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; color: var(--text-dim); transition: 0.2s;
        }
        .nav-item i { font-size: 20px; margin-bottom: 5px; }
        .nav-item span { font-size: 9px; font-weight: bold; line-height: 1; text-align: center; }
        
        .nav-item.active { background: var(--accent-yellow); color: black; border-color: var(--accent-yellow); }
        .nav-item:hover:not(.active) { border-color: #666; color: white; }

        /* Main Content */
        .main-content { flex: 1; padding: 30px; display: flex; gap: 30px; overflow: hidden; }

        /* Preview Area - MODIFIED FOR SMALL TOP-LEFT VIEW */
        .preview-section { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            min-width: 0;
            /* Align to Top Left */
            justify-content: flex-start;
            align-items: flex-start; 
        }
        
        .preview-box {
            /* Small Fixed Size */
            width: 480px; 
            max-width: 100%;
            aspect-ratio: 16/9; 
            background: #000; 
            border: 1px solid var(--border-color);
            position: relative; 
            overflow: hidden; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            margin-bottom: 20px; /* Space below the small preview */
        }
        
        .preview-label {
            position: absolute; top: 12px; left: 12px; z-index: 10;
            display: flex; align-items: center; gap: 6px;
        }
        .pl-dot { width: 6px; height: 6px; background: #666; border-radius: 50%; } 
        .pl-text { font-family: 'Roboto', sans-serif; font-size: 11px; color: #888; font-weight: 500; letter-spacing: 0.5px; }
        
        .live-tag {
            position: absolute; top: 15px; right: 15px; background: var(--accent-red); color: white;
            font-weight: bold; font-size: 10px; padding: 2px 6px; border-radius: 2px; z-index: 10;
        }
        
        /* The Scaled Stage */
        .stage-scaler {
            width: 1920px; height: 1080px; background: #111;
            position: absolute; transform-origin: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        #admin-video-feed { width: 100%; height: 100%; object-fit: cover; }

        /* Connect Overlay */
        .connect-overlay {
            position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; z-index: 20; 
            background: #000;
        }
        .yt-state-container {
            display: flex; flex-direction: column; align-items: center; gap: 12px; text-align: center;
        }
        .yt-icon { font-size: 32px; color: #666; margin-bottom: 5px; opacity: 0.5; }
        .yt-title {
            font-family: 'Roboto', sans-serif; font-size: 16px; color: #fff; font-weight: 500;
        }
        .yt-sub {
            font-family: 'Roboto', sans-serif; font-size: 13px; color: #aaa; max-width: 250px; line-height: 1.4;
        }
        .yt-btn {
            margin-top: 15px;
            background: #282828; 
            border: 1px solid #3e3e3e; 
            color: var(--yt-blue);
            padding: 8px 18px; 
            border-radius: 18px; 
            font-family: 'Roboto', sans-serif; 
            font-size: 14px; 
            font-weight: 500;
            cursor: pointer; 
            transition: 0.2s;
        }
        .yt-btn:hover { background: #3e3e3e; }

        /* Controls Area */
        .controls-section { width: 350px; display: flex; flex-direction: column; gap: 20px; flex-shrink: 0; }

        .control-panel { background: transparent; border: 1px solid var(--border-color); padding: 0; }
        .cp-header {
            color: var(--accent-yellow); font-family: 'Teko'; font-size: 22px; letter-spacing: 1px;
            padding: 10px 15px; border-bottom: 1px solid var(--border-color); text-transform: uppercase;
        }
        .cp-body { padding: 15px; display: flex; flex-direction: column; gap: 15px; }

        .styled-select {
            width: 100%; background: #050505; border: 1px solid #333; color: white;
            padding: 10px; font-family: 'Rajdhani'; font-size: 16px; margin-bottom: 10px;
        }

        .input-group { margin-bottom: 5px; }
        .input-label { display: block; font-size: 11px; color: #666; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        .styled-input {
            width: 100%; background: #050505; border: 1px solid #333; color: white;
            padding: 10px; font-family: 'Rajdhani'; font-size: 16px; transition: 0.2s;
        }
        .styled-input:focus { border-color: var(--accent-yellow); }

        .toggle-row {
            display: flex; justify-content: space-between; align-items: center;
            background: #050505; border: 1px solid #333; padding: 12px 15px; cursor: pointer; transition: 0.2s;
        }
        .toggle-row:hover { border-color: #555; }
        .toggle-row.active { border-color: var(--accent-yellow); background: rgba(212, 255, 0, 0.05); }
        .t-label { font-weight: bold; font-size: 14px; text-transform: uppercase; }
        .t-state { font-weight: bold; color: #444; }
        .toggle-row.active .t-state { color: var(--accent-yellow); }

        .btn-reset {
            width: 100%; background: #2a0000; border: 1px solid #500; color: #ff5555;
            padding: 12px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: 10px;
        }
        .btn-reset:hover { background: #400000; color: white; }

        /* --- 4. GROUP & TEAM EDITOR STYLES --- */
        .group-manager-layout { display: flex; width: 100%; height: 100%; gap: 20px; }
        .group-list { width: 250px; background: #111; border: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
        .group-btn { 
            padding: 15px; background: #050505; border: 1px solid #333; color: #888; cursor: pointer; text-align: left; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }
        .group-btn:hover { border-color: #666; color: white; }
        .group-btn.active { border-color: var(--accent-yellow); color: white; background: rgba(212, 255, 0, 0.05); }
        
        .btn-add-group { width: 100%; padding: 10px; background: #222; border: 1px dashed #444; color: #888; cursor: pointer; margin-top: 10px; }
        .btn-add-group:hover { color: var(--accent-yellow); border-color: var(--accent-yellow); }

        .team-editor-area { flex: 1; background: #111; border: 1px solid #333; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        
        .editor-top-bar { display: flex; gap: 20px; margin-bottom: 20px; align-items: flex-end; }

        .team-editor-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }

        .team-card { background: #050505; border: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 10px; animation: fadeIn 0.3s ease; }
        .team-header { display: flex; gap: 10px; align-items: center; }
        
        .logo-upload-wrapper { position: relative; width: 50px; height: 50px; flex-shrink: 0; }
        .logo-upload-btn { 
            width: 100%; height: 100%; background: #111; border: 1px dashed #444; cursor: pointer; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative;
        }
        .logo-upload-btn img { width: 100%; height: 100%; object-fit: contain; }
        .logo-upload-btn i { font-size: 12px; color: #444; }
        .logo-input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

        .btn-remove-logo {
            position: absolute; top: -5px; right: -5px; 
            width: 16px; height: 16px; background: var(--accent-red); color: white; border: none;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 10px; cursor: pointer; z-index: 10;
        }
        .btn-remove-logo:hover { transform: scale(1.1); }

        .player-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .player-row { display: flex; flex-direction: column; gap: 2px; }

        /* --- 5. LIVE VIEW --- */
        #live-view { position: fixed; inset: 0; background: black; z-index: 9999; display: none; }
        #live-video-feed { width: 100%; height: 100%; object-fit: cover; }
        .btn-live-start {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 20px 40px; font-size: 24px; background: black; border: 2px solid var(--accent-yellow);
            color: var(--accent-yellow); cursor: pointer; z-index: 100;
        }

        /* --- 6. GRAPHICS (OVERLAYS) --- */
        .gfx-layer { position: absolute; inset: 0; pointer-events: none; overflow: hidden; }
        
        /* --- MATCH CARD DESIGN (Smaller) --- */
        .banner-gfx {
            position: absolute; bottom: 0px; left: 0px;
            display: flex; align-items: center;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
            transform: translateX(-150%) scale(0.85);
            transform-origin: bottom left;
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 20; 
        }
        .banner-gfx.visible { transform: translateX(0) scale(0.85); }

        .ban-img-box {
            width: 130px; height: 130px;
            background: var(--accent-yellow); 
            display: flex; justify-content: center; align-items: center;
            padding: 15px;
            z-index: 2;
        }
        
        .ban-img-box img {
            width: 100%; height: 100%;
            object-fit: contain;
        }

        .ban-content { 
            height: 130px; 
            background: white; 
            min-width: 400px;
            padding: 0 40px; 
            display: flex; flex-direction: column; justify-content: center; 
            clip-path: polygon(0 0, 92% 0, 100% 20%, 100% 100%, 0 100%);
            z-index: 1;
            margin-left: -5px; 
        }
        
        .ban-sub { 
            color: #666; 
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700; 
            font-size: 24px; 
            text-transform: uppercase; 
            margin-bottom: 5px; 
            letter-spacing: 2px; 
        }
        
        .ban-main { 
            color: #000; 
            font-family: 'Teko', sans-serif; 
            font-size: 80px; 
            font-weight: 600;
            line-height: 0.8; 
            text-transform: uppercase;
            margin-left: -2px;
        }

        /* Leaderboard styling */
        .lb-gfx {
            position: absolute; bottom: 0px; right: 0px; width: 290px; 
            background: rgba(15, 15, 15, 0.95); border-left: 4px solid var(--accent-yellow);
            display: flex; flex-direction: column; 
            transform: translateX(110%); 
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 10;
        }
        .lb-gfx.visible { transform: translateX(0); }
        .lb-header { background: #222; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .lb-title { font-family: 'Teko'; font-size: 24px; color: white; }
        .lb-badge { background: var(--accent-red); color: white; font-size: 10px; font-weight: bold; padding: 2px 5px; border-radius: 2px; }
        .lb-table { width: 100%; border-collapse: collapse; overflow: hidden; table-layout: fixed; }
        .lb-table th { color: #666; font-size: 10px; padding: 5px 0; border-bottom: 1px solid #333; }
        .lb-table td { padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: center; color: white; font-weight: bold; vertical-align: middle;}
        
        .team-cell { display: flex; align-items: center; gap: 8px; padding-left: 5px; height: 100%; }
        .team-logo-display { width: 24px; height: 24px; object-fit: contain; }
        
        @keyframes eslideEnter {
            0% { opacity: 0; transform: translateX(60px); }
            100% { opacity: 1; transform: translateX(0); }
        }

        .lb-row { 
            opacity: 0; 
            animation: eslideEnter 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .lb-row.wiped { opacity: 0.4; filter: grayscale(1); }
        .s-dots { display: flex; gap: 2px; justify-content: center; }
        .dot { width: 3px; height: 12px; background: white; transform: skewX(-15deg); }
        .dot.out { background: var(--accent-red); opacity: 0.5; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; }

        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="font-family:'Teko'; font-size:80px; color:white; line-height:0.8; margin-bottom:10px;">ESPORTS <span style="color:var(--accent-yellow)">PRO</span></h1>
            <div style="color:#666; margin-bottom:40px; letter-spacing:2px;">PRODUCTION SUITE V15</div>
            <button class="login-btn" onclick="app.enter('admin')">ADMIN PANEL</button>
            <button class="login-btn" onclick="app.enter('live')">LIVE SCREEN</button>
        </div>
    </div>

    <div id="admin-view">
        <div class="sidebar">
            <div class="nav-item active" onclick="app.switchTab('control')">
                <i class="fa-solid fa-sliders"></i>
                <span>CONTROL<br>ROOM</span>
            </div>
            <div class="nav-item" onclick="app.switchTab('groups')">
                <i class="fa-solid fa-layer-group"></i>
                <span>PLAYER<br>GROUPING</span>
            </div>
        </div>

        <div class="main-content">
            
            <div class="preview-section" id="sec-preview">
                <div class="preview-box" id="preview-container">
                    
                    <div class="preview-label">
                        <div class="pl-dot"></div>
                        <span class="pl-text">Connecting...</span>
                    </div>
                    <div class="live-tag">LIVE</div>
                    
                    <div class="connect-overlay" id="preview-overlay">
                        <div class="yt-state-container">
                            <div class="yt-icon">
                                <i class="fa-solid fa-tower-broadcast"></i>
                            </div>
                            <div class="yt-title">Connect streaming software to go live</div>
                            <div class="yt-sub">Viewers will be able to find your stream once you go live</div>
                            <button class="yt-btn" onclick="app.startPreviewSource()">
                                CONNECT SOURCE
                            </button>
                        </div>
                    </div>

                    <div class="stage-scaler" id="preview-stage"></div>
                </div>
            </div>

            <div class="controls-section" id="sec-controls">
                
                <div class="control-panel">
                    <div class="cp-header">BROADCAST CONTROL</div>
                    <div class="cp-body">
                        <span class="input-label">ACTIVE GROUP ON AIR</span>
                        <select id="live-group-select" class="styled-select" onchange="app.setLiveGroup(this.value)">
                            </select>
                        
                        <div class="input-group">
                            <span class="input-label">SUBTITLE (ROUND INFO)</span>
                            <input id="inp-sub" class="styled-input" value="ROUND 2 - GROUP 2 | M3" oninput="app.updateState()">
                        </div>
                        <div class="input-group">
                            <span class="input-label">MAIN TITLE (MAP NAME)</span>
                            <input id="inp-title" class="styled-input" value="MIRAMAR" oninput="app.updateState()">
                        </div>
                        <div class="toggle-row" id="tog-banner" onclick="app.toggle('banner')">
                            <span class="t-label">SHOW MATCH BANNER</span>
                            <span class="t-state">OFF</span>
                        </div>
                    </div>
                </div>

                <div class="control-panel">
                    <div class="cp-header">LEADERBOARD</div>
                    <div class="cp-body">
                        <div class="toggle-row" id="tog-lb" onclick="app.toggle('lb')">
                            <span class="t-label">SHOW LEADERBOARD</span>
                            <span class="t-state">OFF</span>
                        </div>
                        <button class="btn-reset" onclick="app.reset()">RESET ALL DATA</button>
                    </div>
                </div>

            </div>

            <div class="preview-section hidden" id="sec-groups" style="padding:0; border:none; overflow:hidden;">
                <div class="group-manager-layout">
                    <div class="group-list">
                        <div style="font-family:'Teko'; font-size:24px; color:white;">GROUPS</div>
                        <div id="groups-container"></div>
                        <button class="btn-add-group" onclick="app.createGroup()">+ NEW GROUP</button>
                    </div>

                    <div class="team-editor-area">
                        <div class="cp-header" style="border:none; padding-left:0;">EDITING: <span id="edit-group-name" style="color:white">...</span></div>
                        
                        <div class="editor-top-bar">
                            <div class="input-group" style="flex:1; max-width:300px;">
                                <span class="input-label">RENAME GROUP</span>
                                <input id="inp-grp-name" class="styled-input" oninput="app.renameGroup(this.value)">
                            </div>
                            
                            <div class="input-group" style="flex:1; max-width:300px;">
                                <span class="input-label"><i class="fa-solid fa-search"></i> SEARCH (NUMBER OR NAME)</span>
                                <input id="inp-team-search" class="styled-input" placeholder="e.g. '1' for Team #1" oninput="app.renderGroupManager()">
                            </div>
                        </div>
                        
                        <div id="editor-grid" class="team-editor-grid"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="live-view">
        <button class="btn-live-start" id="btn-live-start" onclick="app.startLiveSource()">
            <i class="fa-solid fa-play"></i> START BROADCAST FEED
        </button>
        <div class="gfx-layer" id="live-gfx-layer"></div>
    </div>

    <script>
        // --- CONSTANTS ---
        const CHANNEL_NAME = "esports_v15_sync";
        const STORAGE_KEY = "esports_v15_state";
        
        // Helper to generate a team template
        const createTeam = (i) => ({
            id: i, 
            name: `TEAM ${i+1}`, 
            logo: "", // Base64 data
            kills: 0, 
            points: 0, 
            players: ["Player 1", "Player 2", "Player 3", "Player 4"],
            p_status: [1, 1, 1, 1] // 1=Alive, 0=Dead
        });

        const createGroup = (id, name) => ({
            id: id,
            name: name,
            teams: Array.from({length: 16}, (_, i) => createTeam(i))
        });

        // --- APP ENGINE ---
        const app = {
            state: {
                banner: false,
                lb: false,
                sub: "ROUND 2 - GROUP 2 | M3", 
                title: "MIRAMAR",              
                groups: [ createGroup(Date.now(), "GROUP 1") ],
                activeEditGroupIdx: 0,
                activeLiveGroupIdx: 0
            },
            mode: null,
            channel: new BroadcastChannel(CHANNEL_NAME),

            init() {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if(parsed.groups) this.state = parsed;
                    } catch(e) { console.log("State reset needed"); }
                }

                this.channel.onmessage = (ev) => {
                    if (ev.data) {
                        this.state = ev.data;
                        this.renderAll();
                    }
                };
                window.addEventListener('resize', () => { if(this.mode==='admin') this.fitPreview(); });
            },

            enter(mode) {
                this.mode = mode;
                document.getElementById('login-screen').classList.add('hidden');
                
                if(mode === 'admin') {
                    document.getElementById('admin-view').style.display = 'flex';
                    this.setupGraphics(document.getElementById('preview-stage'));
                    this.renderAll();
                    setTimeout(() => this.fitPreview(), 100);
                } else {
                    document.getElementById('live-view').style.display = 'block';
                    this.setupGraphics(document.getElementById('live-gfx-layer'));
                    this.renderAll();
                }
            },

            // --- STATE MANAGEMENT ---
            sync() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(this.state));
                this.channel.postMessage(this.state);
                this.renderAll();
            },

            updateState() {
                if(this.mode === 'admin') {
                    this.state.sub = document.getElementById('inp-sub').value;
                    this.state.title = document.getElementById('inp-title').value;
                }
                this.sync();
            },

            toggle(key) { 
                this.state[key] = !this.state[key]; 
                this.sync(); 
            },
            
            reset() {
                if(confirm("Reset everything to default?")) {
                    this.state.groups = [ createGroup(Date.now(), "GROUP 1") ];
                    this.state.activeEditGroupIdx = 0;
                    this.state.activeLiveGroupIdx = 0;
                    this.state.banner = false; 
                    this.state.lb = false;
                    this.sync();
                }
            },

            // --- GROUP LOGIC ---
            createGroup() {
                const newName = `GROUP ${this.state.groups.length + 1}`;
                this.state.groups.push(createGroup(Date.now(), newName));
                this.state.activeEditGroupIdx = this.state.groups.length - 1;
                this.sync();
                this.renderControls();
            },

            selectEditGroup(idx) {
                this.state.activeEditGroupIdx = idx;
                document.getElementById('inp-team-search').value = "";
                this.sync(); 
            },

            renameGroup(val) {
                this.state.groups[this.state.activeEditGroupIdx].name = val;
                this.sync();
            },

            setLiveGroup(val) {
                this.state.activeLiveGroupIdx = parseInt(val);
                this.sync();
            },

            // --- TEAM LOGIC ---
            updTeam(teamIdx, field, val, playerIdx = null) {
                const group = this.state.groups[this.state.activeEditGroupIdx];
                const team = group.teams[teamIdx]; 

                if (field === 'players' && playerIdx !== null) {
                    team.players[playerIdx] = val;
                } else if (field === 'kills' || field === 'points') {
                    team[field] = parseInt(val) || 0;
                } else {
                    team[field] = val;
                }
                this.sync();
            },

            togP(teamIdx, playerIdx) {
                const group = this.state.groups[this.state.activeEditGroupIdx];
                const team = group.teams[teamIdx];
                team.p_status[playerIdx] = team.p_status[playerIdx] ? 0 : 1;
                this.sync();
            },

            handleLogoUpload(teamIdx, input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        if(e.target.result.length > 500000) {
                            alert("Image too large! Please use small icons.");
                            return;
                        }
                        this.state.groups[this.state.activeEditGroupIdx].teams[teamIdx].logo = e.target.result;
                        this.sync();
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            removeLogo(teamIdx, event) {
                if(event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                this.state.groups[this.state.activeEditGroupIdx].teams[teamIdx].logo = "";
                this.sync();
            },

            // --- NAVIGATION ---
            switchTab(tab) {
                const prev = document.getElementById('sec-preview');
                const ctrls = document.getElementById('sec-controls');
                const groups = document.getElementById('sec-groups');
                const navC = document.querySelectorAll('.nav-item')[0];
                const navG = document.querySelectorAll('.nav-item')[1];

                if(tab === 'control') {
                    prev.classList.remove('hidden'); ctrls.classList.remove('hidden'); groups.classList.add('hidden');
                    navC.classList.add('active'); navG.classList.remove('active');
                    setTimeout(() => this.fitPreview(), 50);
                } else {
                    prev.classList.add('hidden'); ctrls.classList.add('hidden'); groups.classList.remove('hidden');
                    navC.classList.remove('active'); navG.classList.add('active');
                    this.renderGroupManager();
                }
            },

            // --- RENDERING ---
            renderAll() {
                this.renderGraphics();
                if(this.mode === 'admin') {
                    this.renderControls();
                    if(!document.getElementById('sec-groups').classList.contains('hidden')) {
                         this.renderGroupManager();
                    }
                }
            },

            renderControls() {
                const bTog = document.getElementById('tog-banner');
                const lTog = document.getElementById('tog-lb');
                
                if(this.state.banner) { bTog.classList.add('active'); bTog.querySelector('.t-state').innerText="ON"; }
                else { bTog.classList.remove('active'); bTog.querySelector('.t-state').innerText="OFF"; }

                if(this.state.lb) { lTog.classList.add('active'); lTog.querySelector('.t-state').innerText="ON"; }
                else { lTog.classList.remove('active'); lTog.querySelector('.t-state').innerText="OFF"; }

                const sInp = document.getElementById('inp-sub');
                const tInp = document.getElementById('inp-title');
                if(document.activeElement !== sInp) sInp.value = this.state.sub;
                if(document.activeElement !== tInp) tInp.value = this.state.title;

                const sel = document.getElementById('live-group-select');
                if(document.activeElement !== sel) {
                    sel.innerHTML = this.state.groups.map((g, i) => 
                        `<option value="${i}" ${this.state.activeLiveGroupIdx === i ? 'selected' : ''}>${g.name}</option>`
                    ).join('');
                }
            },

            renderGroupManager() {
                const gContainer = document.getElementById('groups-container');
                gContainer.innerHTML = this.state.groups.map((g, i) => `
                    <div class="group-btn ${this.state.activeEditGroupIdx === i ? 'active' : ''}" onclick="app.selectEditGroup(${i})">
                        <span>${g.name}</span>
                        <i class="fa-solid fa-chevron-right" style="font-size:10px;"></i>
                    </div>
                `).join('');

                const currentGrp = this.state.groups[this.state.activeEditGroupIdx];
                document.getElementById('edit-group-name').innerText = currentGrp.name;
                const nameInp = document.getElementById('inp-grp-name');
                if(document.activeElement !== nameInp) nameInp.value = currentGrp.name;

                if(document.querySelector('.team-card input:focus')) return;

                // --- SEARCH LOGIC ---
                const searchInp = document.getElementById('inp-team-search');
                const searchVal = searchInp ? searchInp.value.trim().toLowerCase() : "";
                
                const isNumericSearch = /^\d+$/.test(searchVal);

                const teamsWithIndex = currentGrp.teams.map((t, idx) => ({...t, origIdx: idx}));
                
                const filteredTeams = teamsWithIndex.filter(t => {
                    if(!searchVal) return true; // Show all if empty
                    if(isNumericSearch) {
                        // Strict comparison for ID (e.g. "1" matches "1")
                        return (t.origIdx + 1).toString() === searchVal;
                    } else {
                        // Normal string includes for text search
                        return t.name.toLowerCase().includes(searchVal);
                    }
                });

                const grid = document.getElementById('editor-grid');
                
                if(filteredTeams.length === 0) {
                    grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:#444;">NO TEAMS MATCHING "${searchVal}"</div>`;
                } else {
                    grid.innerHTML = filteredTeams.map((t) => {
                        const i = t.origIdx; 
                        return `
                            <div class="team-card">
                                <div class="team-header">
                                    <div class="logo-upload-wrapper">
                                        ${t.logo 
                                            ? `<button class="btn-remove-logo" onclick="app.removeLogo(${i}, event)">x</button>` 
                                            : ''
                                        }
                                        <label class="logo-upload-btn">
                                            ${t.logo ? `<img src="${t.logo}">` : `<i class="fa-solid fa-camera"></i>`}
                                            <input type="file" class="logo-input" accept="image/*" onchange="app.handleLogoUpload(${i}, this)">
                                        </label>
                                    </div>
                                    <div style="flex:1;">
                                        <div style="font-size:10px; color:#666; font-weight:bold;">TEAM #${i+1}</div>
                                        <input class="styled-input" value="${t.name}" style="padding:5px; font-size:14px;" onchange="app.updTeam(${i}, 'name', this.value)">
                                    </div>
                                </div>
                                
                                <div style="display:flex; gap:5px;">
                                    <div style="flex:1">
                                        <span class="input-label" style="font-size:9px;">KILLS</span>
                                        <input type="number" class="styled-input" value="${t.kills}" onchange="app.updTeam(${i}, 'kills', this.value)">
                                    </div>
                                    <div style="flex:1">
                                        <span class="input-label" style="font-size:9px; color:var(--accent-yellow)">POINTS</span>
                                        <input type="number" class="styled-input" value="${t.points}" style="color:var(--accent-yellow)" onchange="app.updTeam(${i}, 'points', this.value)">
                                    </div>
                                </div>

                                <div class="player-inputs">
                                    ${t.players.map((pName, pIdx) => `
                                        <div class="player-row">
                                            <input class="styled-input" value="${pName}" style="padding:4px; font-size:12px;" placeholder="P${pIdx+1}" onchange="app.updTeam(${i}, 'players', this.value, ${pIdx})">
                                            <div onclick="app.togP(${i}, ${pIdx})" style="text-align:center; font-size:9px; cursor:pointer; background:${t.p_status[pIdx]?'#222':'#300'}; color:${t.p_status[pIdx]?'#fff':'#f55'}; border:1px solid #333; padding:2px;">
                                                ${t.p_status[pIdx] ? 'ALIVE' : 'DEAD'}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            },

            setupGraphics(stage) {
                stage.innerHTML = `
                    <div class="banner-gfx">
                        <div class="ban-img-box">
                            <img src="https://i.postimg.cc/hj0DRNYS/Chat-GPT-Image-Feb-5-2026-07-06-01-PM.png" alt="Match Graphic">
                        </div>
                        <div class="ban-content">
                            <div class="ban-sub"></div>
                            <div class="ban-main"></div>
                        </div>
                    </div>
                    <div class="lb-gfx">
                        <div class="lb-header"><span class="lb-title">STANDINGS</span><span class="lb-badge">LIVE</span></div>
                        <table class="lb-table">
                            <thead><tr>
                                <th style="width:30px;">#</th>
                                <th style="text-align:left; padding-left:10px;">TEAM</th>
                                <th style="width:40px;">K</th>
                                <th style="width:50px;">PTS</th>
                                <th style="width:50px;">STS</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                `;
            },

            renderGraphics() {
                const stages = [];
                if(this.mode === 'admin') stages.push(document.getElementById('preview-stage'));
                if(this.mode === 'live') stages.push(document.getElementById('live-gfx-layer'));

                stages.forEach(el => {
                    if(!el) return;
                    
                    const ban = el.querySelector('.banner-gfx');
                    if(ban) {
                        ban.querySelector('.ban-sub').innerText = this.state.sub;
                        ban.querySelector('.ban-main').innerText = this.state.title;
                        if(this.state.banner) ban.classList.add('visible'); else ban.classList.remove('visible');
                    }

                    const lb = el.querySelector('.lb-gfx');
                    if(lb) {
                        if(this.state.lb) lb.classList.add('visible'); else lb.classList.remove('visible');

                        const tbody = lb.querySelector('tbody');
                        const liveGroupIdx = this.state.activeLiveGroupIdx;
                        const liveGroup = this.state.groups[liveGroupIdx] || this.state.groups[0];
                        
                        if(liveGroup && tbody) {
                            const sorted = [...liveGroup.teams].sort((a,b) => b.points - a.points);
                            
                            // BUG FIX: Generate new HTML string
                            const newHTML = sorted.map((t, i) => `
                                <tr class="lb-row ${t.p_status.every(x=>x===0)?'wiped':''}" style="animation-delay: ${i * 0.08}s">
                                    <td style="color:#666">${i+1}</td>
                                    <td>
                                        <div class="team-cell">
                                            ${t.logo ? `<img src="${t.logo}" class="team-logo-display">` : ''}
                                            <span>${t.name}</span>
                                        </div>
                                    </td>
                                    <td style="color:#aaa">${t.kills}</td>
                                    <td style="color:var(--accent-yellow); font-size:18px;">${t.points}</td>
                                    <td><div class="s-dots">${t.p_status.map(s=>`<div class="dot ${s?'':'out'}"></div>`).join('')}</div></td>
                                </tr>
                            `).join('');

                            // BUG FIX: Only update DOM if content actually changed.
                            // This prevents the leaderboard from re-rendering (and flashing) when you just toggle the banner.
                            if(tbody.innerHTML !== newHTML) {
                                tbody.innerHTML = newHTML;
                            }
                        }
                    }
                });
            },

            fitPreview() {
                const box = document.getElementById('preview-container');
                const stage = document.getElementById('preview-stage');
                if(!box || !stage) return;
                const scale = Math.min(box.clientWidth/1920, box.clientHeight/1080) * 0.95;
                stage.style.transform = `scale(${scale})`;
            },

            async startPreviewSource() {
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({video: {cursor:"always"}, audio:false});
                    const v = document.createElement('video'); v.id = "admin-video-feed";
                    v.srcObject = stream; v.autoplay = true; v.muted = true;
                    document.getElementById('preview-stage').prepend(v);
                    document.getElementById('preview-overlay').style.display = 'none';
                    // Hide the header label as well once video is active
                    document.querySelector('.preview-label').style.display = 'none';
                } catch(e) { console.error(e); }
            },

            async startLiveSource() {
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({video: {cursor:"always"}, audio:false});
                    const v = document.createElement('video'); v.id = "live-video-feed";
                    v.srcObject = stream; v.autoplay = true; v.muted = true;
                    document.getElementById('live-view').insertBefore(v, document.getElementById('live-gfx-layer'));
                    document.getElementById('btn-live-start').style.display = 'none';
                } catch(e) { console.error(e); }
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
